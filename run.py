#!/usr/bin/env python
# coding=utf-8
from gevent import monkey
from socketio.server import SocketIOServer
import django.core.handlers.wsgi
import os
import sys
from threading import Thread

monkey.patch_all()

try:
    from malwarez import settings
except ImportError:
    sys.stderr.write(u"Error: Can't find the file 'settings.py' in the "
                     u"directory containing {0!r:s}. It appears you've customized things.\n"
                     u"You'll have to run django-admin.py, passing it your settings "
                     u"module.\n(If the file settings.py does indeed exist, it's causing "
                     u"an ImportError somehow.)\n".format(__file__))
    sys.exit(1)

PORT = 10080

os.environ['DJANGO_SETTINGS_MODULE'] = 'malwarez.settings'

application = django.core.handlers.wsgi.WSGIHandler()

if __name__ == '__main__':
    server = None

    print 'Listening on http://127.0.0.1:%s and on port 843 (flash policy server)' % PORT
    server = SocketIOServer(('', PORT), application, resource="socket.io")
    print "Ctrl+C to stop..."

    def start():
        server.serve_forever()

    t = Thread(target=start)
    t.daemon = True
    t.start()
    try:
        t.join()
    except KeyboardInterrupt:
        print 'stopping server'
        server.stop()
        print 'waiting thread'
        t.join()
        print 'Bye!'
