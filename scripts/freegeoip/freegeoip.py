#!/usr/bin/python

# ipdb.sqlite generated by freegeoip project's updatedb command. https://github.com/fiorix/freegeoip
import sqlite3 as lite
import sys
import random
import pygeoip
import os
sPath=os.path.dirname(os.path.realpath(__file__))+'/'
gi = pygeoip.GeoIP(sPath + '../geolite/GeoLiteCity.dat', pygeoip.MEMORY_CACHE)

def __getIPRangeList(sql_query, params):
    SQL_FILE='ipdb.sqlite'
    con = lite.connect(SQL_FILE)

    ip_start = 0
    ip_end = 1

    rangeList = []
    with con:
        cur = con.cursor()
        cur.execute(sql_query, params)
        rows = cur.fetchall()
        for row in rows:
            sip = row[ip_start]
            eip = row[ip_end]
            rangeList.append((sip, eip))

    return rangeList


def getIPRangeListByCity(city_name):
    sql_query='SELECT ip_start, ip_end FROM city_blocks, city_location WHERE city_name LIKE ? AND city_blocks.loc_id=city_location.loc_id'
    params = (city_name, )
    return __getIPRangeList(sql_query, params)

def getIPRangeListByCountry(country_name):
    sql_query='SELECT ip_start, ip_end FROM country_blocks WHERE country_name LIKE ?'
    params=(country_name, )
    return __getIPRangeList(sql_query, params)

def __selectRandomIP(ip_range, count) :
    rIP = []
    for x in xrange(0, count) :
        i = random.randint(0, len(ip_range))
        start_ip = int(ip_range[i][0])
        end_ip = int(ip_range[i][1])

        rIP.append(random.randint(start_ip, end_ip))

    return rIP

def getRandomIPByCity(city_name, count=0) :
    ip_range=getIPRangeListByCity(city_name)
    return __selectRandomIP(ip_range, count)

def getRandomIPByCountry(country_name, count=0) :
    ip_range=getIPRangeListByCountry(country_name)
    return __selectRandomIP(ip_range, count)

def convertToIPNum(ipStr):
    octets = ipStr.split('.')
    ip_num = (  (int(octets[0]) << 24)
                + (int(octets[1]) << 16)
                + (int(octets[2]) << 8 )
                + (int(octets[3]))
            )

    return ip_num

def convertToIPStr(ipNum) :
    o1 = str((ipNum >> 24) & 0xFF)
    o2 = str((ipNum >> 16) & 0xFF)
    o3 = str((ipNum >> 8 ) & 0xFF)
    o4 = str((ipNum      ) & 0xFF)

    address = o1 + '.' + o2 + '.' + o3 + '.' + o4
    return address

def getCityInfoByIp(ipAddr):
    return gi.record_by_addr(ipAddr)

if __name__ == '__main__':
    ips = getRandomIPByCity('New York', 10)
    for rip in ips :
        ripStr = convertToIPStr(rip)
        print ripStr, ' -- ', getCityInfoByIp(ripStr)

    ips = getRandomIPByCountry('Germany', 10)
    for rip in ips :
        ripStr = convertToIPStr(rip)
        print ripStr, ' -- ', getCityInfoByIp(ripStr)
