#!/usr/bin/python

if __name__ == '__main__' :

    import json
    import sys
    import time
    import os
    import django
    from subprocess import PIPE, STDOUT, Popen, call

    sPath=os.path.dirname(os.path.realpath(__file__))+'/'
    sys.path.append(sPath+'../../../lib/python2.7/site-packages/')
    sys.path.append(sPath+'../freegeoip/')
    sys.path.append(sPath+'../../')

    from socketIO_client import SocketIO
    import freegeoip

    # Set the DJANGO_SETTINGS_MODULE environment variable.
    os.environ['DJANGO_SETTINGS_MODULE'] = "malwarez.settings"
    from web.models import Feed

    HPFRIENDS='hpfeeds-client'
    DUMMY_HPFRIENDS=sPath + 'dummyGenerator.py'

    selected_feedSource = DUMMY_HPFRIENDS

    accountFile = open(sPath+'hpfriends.json', 'r')
    account = json.load(accountFile)


    socketIO = SocketIO('127.0.0.1', 8000)
    chatSocket = socketIO.connect('/new-event')

    cmd = [selected_feedSource,
           '-i', account['user'],
           '-s', account['pass'],
           '--host', account['host'],
           '-p', account['port'],
           '-c', account['capture'],
           account['action']]

    pHpf=Popen(cmd,)
    feedStdout, feedStderror = pHpf.communicate()
    #feedStdout = pHpf.stdout
    while True:
        newFeed = feedStdout.readline()
        print '> ', newFeed
        if(newFeed) :
            data = json.loads(newFeed)
            f = Feed(url=data['url'], daddr=data['daddr'], saddr=data['saddr'], sport=data['sport'], dport=data['dport'], sha512=data['sha512'], md5=data['md5'])
            #if s is not None:
            info = freegeoip.getCityInfoByIp(f.saddr)
            if(info) :
                coordinate = "{\"x\": \"%f\", \"y\": \"%f\"}" % (info['longitude'], info['latitude'])
                chatSocket.emit('update', coordinate)


    #print 'cmd: ', cmd

    # socketIO = SocketIO('127.0.0.1', 8000)
    # chatSocket = socketIO.connect('/new-event')
    #
    # i=0
    # while True:
    #     i += 1
    #     chatSocket.emit('update', {'x': (40 + i)%100, 'y': 40})
    #     time.sleep(1.5)
    #     print 'update sent.'
    #
    # #socketIO.emit('aaa', {'bbb': 'ccc'})
    # socketIO.wait()