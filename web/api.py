from tastypie import fields
from tastypie.resources import Resource
from tastypie.bundle import Bundle
from tastypie.exceptions import NotFound
from web.models import Feed
from django.db import connection
import freegeoip

class Event() :
    def __init__(self, myJSON={'test-key':'test-value'}):
        self.myJSON = myJSON



class EventResource(Resource):
    class Meta:
        object_class = Event
        resource_name='events'

    def get_object_list(self, request):
        results = []

        for x in range(0, 5):
            new_obj = Event(myJSON={'test-key-' + x:'test-value-' + x})
            #new_obj.uuid = result[0]
            results.append(new_obj)

        return results

summary_id=0

class SummaryFeed():
    #{"city":"Sanayi", "freq":57, "longlat":[31, 37]},
    def __init__(self):
        global summary_id
        self.id = summary_id
        summary_id += 1

        self.freq = -1
        self.longlat = [-1, -1]
        self.city = ''


results = {}

class SummaryFeedResource(Resource):
    id = fields.CharField(attribute='id')
    freq = fields.IntegerField(attribute = 'freq')
    city = fields.CharField(attribute = 'city')
    longlat=fields.ListField(attribute='longlat')


    class Meta:
        resource_name = 'summary'
        object_class = SummaryFeed
        limit = 2000

    # adapted this from ModelResource
    # def get_resource_uri(self, bundle_or_obj=None):
    #     kwargs = {
    #         'resource_name': self._meta.resource_name,
    #     }
    #     if isinstance(bundle_or_obj, Bundle):
    #         kwargs['pk'] = bundle_or_obj.obj.id # pk is referenced in ModelResource
    #     else:
    #         kwargs['pk'] = bundle_or_obj.id
    #     if self._meta.api_name is not None:
    #         kwargs['api_name'] = self._meta.api_name
    #     return self._build_reverse_url('api_dispatch_detail', kwargs = kwargs)

    def get_object_list(self, request):
        global results
        results.clear()

        cursor = connection.cursor()
        cursor.execute('SELECT COUNT(*) as freq, longitude, latitude, city FROM web_feed GROUP BY longitude, latitude ORDER BY freq DESC')
        rows = cursor.fetchall()
        for r in rows :
            #print 'args: ',r[0], [r[1], r[2]], r[3]
            s = SummaryFeed()
            s.freq=r[0]
            s.longlat=[r[1], r[2]]
            s.city=r[3]
            s.id='%f_%f'%(r[1], r[2])

            results[s.id] = s

        return results.values()

    def obj_get_list(self, request = None, **kwargs):
        # outer get of object list... this calls get_object_list and
        # could be a point at which additional filtering may be applied
        return self.get_object_list(request)

    def obj_get(self, request = None, **kwargs):
        global results
    # get one object from data source
        pk = int(kwargs['pk'])
        try:
            return results[pk]
        except KeyError:
            raise NotFound("Object not found")