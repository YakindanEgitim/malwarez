var MalwarezPopup = function() {
    var infoModalId = "#myInfoModal";
    var countryModalId = "#myModal";
    var countryMapId = "#countryMap"

    /* PRIVATE VARIABLE DEFINITION */
    var countryMap;
    /* END OF PRIVATE DEFINITION */


    /* BASIC INFO MODAL FUNCTIONS */
    function _showInfoModal(msg) {
        if(typeof msg != 'undefined') {
            $(infoModalId +' .modal-body').html(msg);
        }
        $(infoModalId).modal('show');
    }

    function _closeInfoModal() {
        $(infoModalId).modal('hide');
    }
    /* END OF BASIC INFO MODAL FUNCTIONS */

    function _loadCountryMap(countryData, postProcessCallback) {
        var c, scale, updateMap, symbols = [];

        var countryCode = countryData.id.toLowerCase();
        var mapPath = '/s/maps/country/map-'+countryCode+'.svg';

        c = $(countryMapId);
        c.height(c.width()*0.5);

        try {
            countryMap = $K.map(countryMapId);
        }catch(e) {
            console.log('error');
        }

        countryMap.loadMap(mapPath, function() {
            countryMap.addLayer('graticule', {
                styles: {
                    'stroke-opacity': 0.7,
                    'stroke-width': 0.5,
                    'stroke-dasharray': 3.4
                }
            });
            countryMap.addLayer('graticule_1', {
                styles: {
                    'stroke-opacity': 0.7,
                    'stroke-width': 0.2
                }
            });
            countryMap.addLayer(countryCode, {
                styles: {
                    'stroke': '#fff',
                    'fill': '#cccccf',
                    'fill-opacity': 0.7
                }
            });

            // TODO: Use JSON for test purpose. Replace it with RESTFull API
            //var dataFile = '/s/maps/sample-country-'+ countryCode +'-data.json';
            //var dataFile = '/api/v1/summary-country/'+countryCode+'/?format=json'
            var dataFile = '/summary-country/'+countryCode+'/';
            $.getJSON(dataFile, function(dataset) {
                postProcessCallback(countryMap, dataset, 'freq');
            });

            $('#loadingImage').hide();
        });

        $('.btn').click(function(event) {
            var tgt = $(event.target), par = tgt.parent();
            $('.btn', par).removeClass('btn-primary');
            tgt.addClass('btn-primary');
            updateMap();
        });
    };

    function _showCountryMap(countryData, postProcessCallback) {
        /* TODO: Make an AJAX request and show modal */

        /* Update Modal Content */
        /* TODO: Improve it! This is just for demo. */

        $(countryModalId).on('shown', function() {
            _loadCountryMap(countryData, postProcessCallback);
        });

        /* Show Modal */
        $(countryModalId).on('hidden', function() {
            var paperDom = countryMap.paper.canvas;
            paperDom.parentNode.removeChild(paperDom);
        });
        $(countryMapId).css({
            top                 : '2%',
            border              :'1px solid black',
            '-webkit-box-sizing': 'border-box',
            '-moz-box-sizing'   : 'border-box',
            'box-sizing'        : 'border-box'
        });

        if(typeof msg != 'undefined') {
            $(countryModalId).html(msg);
        }
        $(countryModalId).modal('show').css({
            width: '90%',
            height: '80%',
            'margin-left': function () {
                return -($(this).width() / 2);
            }
        });
    }
    function _closeCountryModal() {
        $(countryModalId).modal('hide');
    }


    return new Object({
        showInfoModal       : _showInfoModal,
        closeInfoModal      : _closeInfoModal,
        showCountryMap      : _showCountryMap,
        closeCountryModal   : _closeCountryModal
    });
}();
