var Malwarez = function() {
    var zo;
    var worldMap;
    var activeMainMapFeature;
    var activeMainMapFeatureType;
    var datasource;


    $(document).ready(function() {
        $script.ready(['jquery', 'kartograph', 'malwarez-ui'], function() {
            MalwarezPopup.showInfoModal('Loading...');
            initLeftPanel();
            initMenuButtons();
            initFilters();

            $(function() {
                $.fn.qtip.defaults.style.classes = 'qtip-bootstrap';
                $.fn.qtip.defaults.style.def = false;

                var svgMap = '/s/maps/world-simple.svg';
                var layerId = 'countries';
                worldMap = $K.map('#map');
                //worldMap = $K.map('#map').showZoomControls();

                var pathId = -1;
                worldMap.loadMap(svgMap, function(map) {
                    map.addLayer('countries', {
                        styles: {
                            fill: '#abc',
                            stroke: '#fff'
                        },
                        chunks: 50,
                        click: function(data, path, event) {
                            // handle mouse clicks
                            // *data* holds the data dictionary of the clicked path
                            // *path* is the raphael object
                            // *event* is the original JavaScript event
                            event.stopPropagation();
                            Malwarez.openCountryMap(data.id);
                        }
                    });
                    clearMainMapFeatureAndStartNewOne(ActivityMap);
                    //clearMainMapFeatureAndStartNewOne(AttackGraphMap, true);
    /*
                    zo = worldMap.showZoomControls().zc;
                    //zo = new $K.PanAndZoomControl(worldMap);
                    $('#zoomIn').on('click', function(){
                        zo.zoomIn();
                    });

                    $('#zoomOut').on('click', function(){
                        zo.zoomOut();
                    });
    */

                });
            });
        });
    });

    function _updateCountry(message) {
        MalwarezSymbols.updateBarGraph(message);
    }

    function  _addEvent(message) {
        console.log('_addEvent(message)');
        console.log(message);
        if(! activeMainMapFeature) {
            console.log('can not add new event. map is not ready');
            return;
        }

        message = JSON.parse(message);
        var x = message.x;
        var y = message.y;
        var dataId = x+'_'+y;
        var country = message.country;
        var city = message.city;
        var newData = {"city": city, "freq":1, "id":dataId, "longlat":[x, y], "country": country};

        // Check data if it is country specific.
        if(Malwarez.selectedCountryCode != null) {
            if (message.country.toUpperCase() === Malwarez.selectedCountryCode.toUpperCase()) {
                _updateCountry(message);
            }
        }
        activeMainMapFeature.addEvent(newData);
    };

    $.asm = {};
    $.asm.panels = 1;
    function initLeftPanel(){
        /*==================================================================*/
        /*==================================================================*/
        /*==================================================================*/
        function sidebar(panels) {
            $.asm.panels = panels;
            if (panels === 1) {
                $('#sidebar').animate({
                    left: -240
                });
            } else if (panels === 2) {
                $('#sidebar').animate({
                    left: 0
                });
            }
        };

        $('#toggleSidebar').click(function() {
            if ($.asm.panels === 1) {
                $('#toggleSidebar i').addClass('icon-chevron-left');
                $('#toggleSidebar i').removeClass('icon-chevron-right');
                return sidebar(2);
            } else {
                $('#toggleSidebar i').removeClass('icon-chevron-left');
                $('#toggleSidebar i').addClass('icon-chevron-right');
                return sidebar(1);
            }
        });

        /*==================================================================*/
        /*==================================================================*/
        /*==================================================================*/

        var _leftPanelId = 'infoLeftPanel';

        function loadStats(_type, _header) {
            /* TODO: Make it more generic. Send data with header */
            $.getJSON('/top/'+ _type +'/', function(dataset){
                var newId = _leftPanelId+_type;
                $('#'+_leftPanelId).append('<span id="'+ newId +'"></span>');
                $('#'+newId).append('<li class="nav-header">'+_header+'</li>');
                $.each(dataset, function(i, d){
                    if(_type === 'attackerIP') {
                        $('#' + newId).append('<li><a style="cursor:pointer;" onclick="MalwarezPopup.showAttackerIPDetail(\''+ _type +'\', \''+ _header +'\', \''+ d[0] +'\');">'+d[0] + ' (' + d[1] + ')'+'</a></li>')
                    } else {
                        $('#' + newId).append('<li>'+d[0] + ' (' + d[1] + ')</li>')
                    }
                });
            });
        }

        loadStats('attackerCountry', 'Attacker Country(Hit Count)');
        loadStats('attackerIP', 'Attacker IP(Hit Count)');
        loadStats('attackerPort', 'Attacker Port(Hit Count)');
        loadStats('targetPort', 'Target Port(Hit Count)');
    }

    function initMenuButtons() {
        var aboutContent = "";
        $('#about').on('click', function() {
            aboutContent = $('#about-content').html();
            MalwarezPopup.showInfoModal(aboutContent);
        });

        $('#heatmap').on('click', function(){
            $('#dataFilter').css('display', 'inline');
            _updateActiveClass(this);
            clearMainMapFeatureAndStartNewOne(HeatMap);
        });

        $('#attack-graph').on('click', function(){
            $('#dataFilter').css('display', 'none');
            alert('Not yet implemented.');
            //_updateActiveClass(this);
            //clearMainMapFeatureAndStartNewOne(AttackGraphMap);
        });

        $('#malware-activity').on('click', function(){
            $('#dataFilter').css('display', 'none');
            _updateActiveClass(this);
            clearMainMapFeatureAndStartNewOne(ActivityMap);
        });

        function _updateActiveClass(e) {
            $('ul#topMenuItems li.active').removeClass('active');
            $(e).parent().addClass("active");
        }
    }

    function initFilters() {

        $('#filterNumberMalware').on('click', function() {
            __updateFilter(FILTERS.MalwareActivity);
        });
        $('#filterDiversityMalware').on('click', function() {
            __updateFilter(FILTERS.MalwareDiversity);
        });
        $('#filterDiversityIP').on('click', function() {
            __updateFilter(FILTERS.IPDiversity);
        });

        function __updateFilter(filter) {
            MalwarezPopup.showInfoModal('Loading...');
            // TODO: Revise this part. No need to get the data again. Set filter and update map!!!
            clearMainMapFeatureAndStartNewOne(activeMainMapFeatureType, filter);
            console.log('filter: ' + filter);
            MalwarezPopup.closeInfoModal();
        }
    }

    /**
     *  clears the active map and starts the new one
     *
     *  @param newFeature: class of the new map such as: HeatMap, ActivityMap or AttackGraph
     **/
    var __firstTime = true; /* For inner usage do not use or change it... */
    function clearMainMapFeatureAndStartNewOne(newFeature, filter){
        activeMainMapFeatureType = newFeature;
        if(! __firstTime) {
            __firstTime = false;
            MalwarezPopup.showInfoModal('Loading...');
        }
        if(activeMainMapFeature) {
            var tmp = activeMainMapFeature;
            activeMainMapFeature = null;
            tmp.clean();
        }

        var url = '/api/v1/summary/?format=json&limit=0';

        if(filter){
            if(filter === FILTERS.IPDiversity) {
                url = '/filter/ip';
            } else if(filter === FILTERS.MalwareDiversity) {
                url = '/filter/malware';
            }
        }

        $.getJSON(url, function(dataset) {
            /* This part needs to change */
            console.log(document.URL);

            datasource = new DataSource(dataset, filter);

            activeMainMapFeature = new newFeature(worldMap, datasource);
            activeMainMapFeature.init();
            if(__firstTime) {
                MalwarezSocket.start();
            }
            MalwarezPopup.closeInfoModal();
        });
    }

    function _openCountryMap(countryId) {
        Malwarez.selectedCountryCode = countryId;
        var postProcessCallback =  MalwarezSymbols.drawBarGraph;
        MalwarezPopup.showCountryMap(countryId, postProcessCallback);
    }

    return new Object({
        addEvent    : _addEvent,
        selectedCountryCode : null,
        openCountryMap : _openCountryMap
    });
}();