$(document).ready(function() {

    var worldMap;
    var countryData = {};
    var countryStats = new Object();

    $script.ready(['jquery', 'kartograph', 'malwarez-ui'], function() {
        $(function() {
            MalwarezPopup.showInfoModal('Loading...');

            $.fn.qtip.defaults.style.classes = 'qtip-bootstrap';
            $.fn.qtip.defaults.style.def = false;

            var svgMap = '/s/maps/world-detailed3.svg';
            var layerId = 'countries';
            worldMap = $K.map('#map');

            var pathId = -1;
            worldMap.loadMap(svgMap, function(map) {
                map.addLayer('countries', {
                    styles: {
                        fill: '#abc',
                        stroke: '#fff'
                    },
                    chunks: 50,
                    tooltips: function(data) {
                        /*
                        console.log('>' + $(this).attr('id'));
                        var json_data = JSON.stringify(data);
                        console.log('json: ' + json_data);
*/
                        /*console.log('id: ' + is + " | path: " + path);*/
                        /* TODO: this part should be dynamic */
                        if(typeof countryStats[data.name] == 'undefined') {
                            countryStats[data.name] = Math.round((Math.random() * 10000) / 100);
                        }

                        var k='';
                        $.each(data, function(_key, _val) {
                            k += "|" + _key + '='+ _val +'|';
                        });

                        pathId++;
                        countryData["path_" + pathId] = data;

                        return "pathId: " + pathId+ "<br/>" + data.name + "<br/> # of Incident:" + countryStats[data.name] + "<br/> all keys:" + k;

                    }
                });

                /*showGrid(map); */
                /* Izmir 38.2381801째 N, 26.9604492째 E */
                drawPoint(worldMap, 26.9604492, 38.2381801);
                /* Berlin 52.5233째 N, 13.4127째 E */
                drawPoint(worldMap, 13.4127, 52.5233);

                initComponents();

                MalwarezPopup.closeInfoModal();
/*
                worldMap.addSymbols({
                    type: $K.Label,
                    data: [{ name: 'Zero', lon: (26.96 - 70), lat: 38.23 }],
                    location: function(d) { return [d.lon, d.lat] },
                    text: function(d) { return d.name; }
                });
*/
            });

        });
    });

    function drawBar(map, x, y, d) {
        var tooltipTitle = '';
        var tooltipText = '';

        var x1 = 0;
        var y1 = 0;
        /* TODO: calculate next point */
        drawShape(map, x, y, x1, y1, tooltipTitle, tooltipText);
    }

    function drawPoint(map, x, y) {
        var tooltipTitle = '';
        var tooltipText = 'Text x: ' + x + ' y: ' + y;
        drawShape(map, x, y, x, y, tooltipTitle, tooltipText);
    }

    function drawShape(map, x, y, x1, y1, tooltipTitle, tooltipText) {
        x = x - 70;
        x1 = x1 - 70;

        var src = new Array(x, y);
        var dst = new Array(x1, y1);
        var shape = map.addGeoPath([src, dst]);
        shape.attr({
            stroke: '#FF0000',
            opacity:.75,
            'stroke-width': 5,
            fill: '#FF0000',
            'stroke-linecap': 'round'
        });

        if (Raphael.svg) {
            setTimeout(function() {
                $(shape.node).qtip({
                    content: {
                        title: tooltipTitle,
                        text: tooltipText
                    },
                    position: {
                        target: 'mouse',
                        viewport: $(window),
                        adjust: { x:7, y:7}
                    }
                }, 0);
            }, 0);

        } else {
            shape.attr('path', map.getGeoPathStr(pts));
        }

        return shape;
    }

    function showGrid(map) {
        var i, j;
        for(j=-90; j<=90; j+=10) {
            for(i=-180; i<=180; i+=10) {
                drawPoint(map, i, j);
            }
        }
    }

    function initComponents() {
        $('.countries').each(function(index) {
            $(this).on('mouseover', function() {
                $(this).css("fill", "#FF0000");
            });
            $(this).on('mouseout', function(){
                $(this).css("fill", "#ABC");
            });
            $(this).on('click', function(){
                countryId=$(this).attr('id');
                postProcessCallback = function() {
                    /*alert('Map Loaded');*/
                }
                MalwarezPopup.showCountryMap(countryId, countryData, postProcessCallback);
            });
        });
    }
});
