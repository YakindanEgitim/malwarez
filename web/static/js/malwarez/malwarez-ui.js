$(document).ready(function() {

    var worldMap;
    var countryData = {};
    var countryStats = new Object();

    $script.ready(['jquery', 'kartograph', 'malwarez-ui'], function() {
        $(function() {
            MalwarezPopup.showInfoModal('Loading...');

            $.fn.qtip.defaults.style.classes = 'qtip-bootstrap';
            $.fn.qtip.defaults.style.def = false;

            var svgMap = '/s/maps/world-detailed3.svg';
            var layerId = 'countries';
            worldMap = $K.map('#map');

            var pathId = -1;
            worldMap.loadMap(svgMap, function(map) {
                map.addLayer('countries', {
                    styles: {
                        fill: '#abc',
                        stroke: '#fff'
                    },
                    chunks: 50,
                    tooltips: function(data) {
                        /* TODO: this part should be dynamic */
                        if(typeof countryStats[data.name] == 'undefined') {
                            countryStats[data.name] = Math.round((Math.random() * 10000) / 100);
                        }

                        pathId++;
                        countryData["path_" + pathId] = data;
                        return "pathId: " + pathId+ "<br/>" + data.name + "<br/> # of Incident:" + countryStats[data.name];
                    },
                    click: function(data, path, event) {
                        // handle mouse clicks
                        // *data* holds the data dictionary of the clicked path
                        // *path* is the raphael object
                        // *event* is the original JavaScript event
                        countryId=data.id
                        postProcessCallback = function() {
                            /*alert('Map Loaded');*/
                        }
                        MalwarezPopup.showCountryMap(data, postProcessCallback);
                    },
                    mouseenter: function(data, path, event) {
                        path.attr("fill", "#FF0000");
                    },
                    mouseleave:function(data, path, event) {
                        path.attr("fill", "#ABC");
                    }
                });

                /* countryData = layer.getPathsData(); */

                /*showGrid(map); */
                /* Izmir 38.2381801째 N, 26.9604492째 E */
                MalwarezSymbols.drawPoint(worldMap, 26.9604492, 38.2381801);
                /* Berlin 52.5233째 N, 13.4127째 E */
                MalwarezSymbols.drawPoint(worldMap, 13.4127, 52.5233);

                MalwarezPopup.closeInfoModal();
/*
                worldMap.addSymbols({
                    type: $K.Label,
                    data: [{ name: 'Zero', lon: (26.96 - 70), lat: 38.23 }],
                    location: function(d) { return [d.lon, d.lat] },
                    text: function(d) { return d.name; }
                });
*/
            });
        });
    });
});
