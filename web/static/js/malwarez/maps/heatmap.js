var HeatMap;

$(function() {

    // Move this to an util class/function
    function checkParam(d, v) {
        if(d) { return d; }
        else  { return v; }
    }

    /**
     * Constructor
     */
    HeatMap = function(map, data, layer, key) {
        this.map = map;
        this.data = {};
        this.color = null;
        this.key = checkParam(key, 'freq');
        this.layer = checkParam(layer, 'countries');

        this.color = null;
        this.oldStyles = null;

        var me = this;
        key = this.key;
        $.each(data.objects, function(i, d) {
            /* Simple indexing for socket.io updates */
            if(!me.data[d.country]) {
                me.data[d.country] = { 'country': d.country };
                me.data[d.country][key] = 0;
            }
            me.data[d.country][key] += d[key];
        });
    }

    /**
     * Initialize the symbols and
     */
    HeatMap.prototype.init = function() {
        var me = this;
        me.oldStyles={};
        me.oldStyles['fill'] = $(me.map.getLayer(me.layer).paths[0].svgPath)[0].attr('fill');
        me.oldStyles['stroke'] = $(me.map.getLayer(me.layer).paths[0].svgPath)[0].attr('stroke');
        me.oldStyles['stroke-width'] = $(me.map.getLayer(me.layer).paths[0].svgPath)[0].attr('stroke-width');
        me.update();

        /* Span element added for easy tooltip update... */
        me.map.getLayer('countries').tooltips(
            function(d) {
                var divId = 'TT_'+ d.id;
                if(me.data[d.id]){
                    return [d.name, '# of activities: <span id="'+ divId +'">' + me.data[d.id][me.key] + '</span>'];
                } else {
                    return [d.name, '# of activities: <span id="'+ divId +'">0</span>'];
                }

            }
        );
    }

    /**
     * Clear all symbols
     */
    HeatMap.prototype.clean = function() {
        // Nothing to do.
        var me = this;
        me.map.getLayer(me.layer).style(me.oldStyles);
    }

    /**
     * Add new event to existing map and update the symbols
     */
    HeatMap.prototype.addEvent = function(newData) {
        //this.map.getLayer(this.layer).css('fill');
        //updateToolTip(newData)

        var me = this;
        MalwarezSymbols.drawPoint(me.map, newData.longlat[0], newData.longlat[1], '#00FF00');
        var key = me.key;
        var id = newData.country;
        var val = 1;
        if(! me.data[id]) {
            me.data[id]={};
            me.data[id]['country'] = id;
            me.data[id][me.key] = 0;
        }
        me.data[id][me.key] += 1;
        val = me.data[id][me.key];

        // Update country tooltip...
        $("span#TT_" + id).html(val);

        me.update(true)

    }

    /**
     * Update map
     */
    HeatMap.prototype.update = function(passScale) {
        var me = this;
        var map = me.map;
        var key = me.key;
        var data = me.data;
        var layer = me.layer;

        /* TODO: No need to update each time... Recalculate scale if only the upper bound increased by 25. */
        if(!passScale) {
            me.color = chroma.scale('Reds').domain(data, 25, 'quantiles', key);
        }
        var color = me.color;

        map.getLayer(layer).style('stroke-width', 0.7);
        map.getLayer(layer).style('fill',
            function(d) {
                var v = 0;
                if(data[d.id]) {
                    v = data[d.id][key];
                }
                return color(v);
            });

        map.getLayer(layer).style('stroke',
            function(d) {
                var v = 0;
                if(data[d.id]) {
                    v = data[d.id][key];
                }
                return color(v).darken(0.5);
            });
    }
});
