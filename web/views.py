# Create your views here.
from django.shortcuts import render_to_response
from django.utils.translation import ugettext as _
from django.db import connection
from django.http import HttpResponse
import json

def index(request):
    return render_to_response('index.html',{'hello_text':'Hello World'})

def test(request):
    return render_to_response('test.html')


class SummaryFeed():
    def __init__(self, id, freq, city, longlat):
        self.id = id
        self.freq = freq
        if city :
            self.city= city
        else:
            self.city= _("<Unknown>")
        self.longlat= longlat

    def to_json_dict(self):
        #return json.dumps({k: str(v) for k, v in self.__dict__.items()})
        return {"id" : self.id, "freq" : self.freq, "city" : self.city, "longlat": self.longlat }


def getSummaryByCountry(request, countryCode):
    result = []

    print 'Hello World! This is easy!!!'
    #countryCode = request.GET.get('countryCode', '')
    #print 'countryCode: ' + countryCode
    countryCode = countryCode.upper()
    cursor = connection.cursor()
    cursor.execute('SELECT COUNT(*) as freq, longitude, latitude, city FROM web_feed WHERE country = %s GROUP BY longitude, latitude ORDER BY freq DESC', [countryCode] )
    rows = cursor.fetchall()
    for r in rows :
        id='%f_%f'%(r[1], r[2])
        s = SummaryFeed(id, r[0], r[3], [r[1], r[2]])
        result.append(s)

    return HttpResponse(json.dumps([s.to_json_dict() for s in result]), mimetype='application/json')
